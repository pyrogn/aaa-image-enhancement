<html lang="en">
    <head>
        <meta charset="utf-8" />
        <meta name="viewport" content="width=device-width, initial-scale=1" />
        <title>Image Selector</title>
        <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet" />
        <style>
            .image-container {
                display: flex;
                justify-content: center;
                align-items: center;
                margin-bottom: 20px;
            }

            .image-container img {
                max-height: 500px;
                border: 5px solid black;
                cursor: pointer;
            }

            .notification {
                position: fixed;
                top: 20px;
                left: 50%;
                transform: translateX(-50%);
                background-color: white;
                padding: 10px;
                border: 1px solid black;
                display: none;
            }

            .overlay {
                position: fixed;
                top: 0;
                left: 0;
                width: 100%;
                height: 100%;
                background-color: rgba(0, 0, 0, 0.5);
                display: none;
                align-items: center;
                justify-content: center;
                z-index: 1000;
            }

            .overlay-content {
                background-color: white;
                padding: 20px;
                border-radius: 5px;
                text-align: center;
            }
        </style>
    </head>

    <body>
        <div class="container">
            <div class="row">
                <div class="col text-center">
                    <h1>❤️ Выберите понравившуюся фотографию ❤️</h1>
                    <button onclick="showOverlay()">Подробности</button>
                </div>
            </div>
            <div class="row">
                <div class="col image-container" data-image-index="0">
                    <img src="{{ images[0] }}" class="img-fluid" alt="Image 0" />
                </div>
                <div class="col image-container" data-image-index="1">
                    <img src="{{ images[1] }}" class="img-fluid" alt="Image 1" />
                </div>
            </div>
        </div>
        <div class="overlay" id="overlay">
            <div class="overlay-content">
                <p>Просто выбирайте понравившуюся фотографию!</p>
                <p>Ваш идентификатор: IP + UserAgent</p>
                <p><a href="https://github.com/pyrogn/aaa-image-enhancement">Source Code</a></p>
                <p>Спасибо за участие!!!</p>
                <button onclick="closeOverlay()">Close</button>
            </div>
        </div>
        <div class="notification" id="notification"></div>

        <script>
            // need to ask not to spam // this will create latency between calls // but don't forget to validate requests in backend
            function debounce(func, wait) {
                let timeout;
                return function (...args) {
                    clearTimeout(timeout);
                    timeout = setTimeout(() => {
                        func.apply(this, args);
                    }, wait);
                };
            } // show window with info
            function showOverlay() {
                document.getElementById("overlay").style.display = "flex";
            }
            function closeOverlay() {
                document.getElementById("overlay").style.display = "none";
            } // update event listeners on change
            document.addEventListener("DOMContentLoaded", function () {
                updateImageEventListeners();
            });
            function updateImageEventListeners() {
                const imageContainers = document.querySelectorAll(".image-container");
                imageContainers.forEach((container) => {
                    container.removeEventListener("click", handleImageClick); // Remove existing event listener to prevent duplicates
                    container.addEventListener("click", handleImageClick);
                });
            }
            function handleImageClick(event) {
                const container = event.currentTarget;
                const imageIndex = container.getAttribute("data-image-index");
                const selectedImage = container.querySelector("img").src;
                const nonSelectedImageIndex = imageIndex === "0" ? "1" : "0";
                const nonSelectedImage = document.querySelector(`.image-container[data-image-index="${nonSelectedImageIndex}"] img`).src;
                console.log("Selected image:", selectedImage);
                console.log("Non-selected image:", nonSelectedImage); // Send the selection to the backend
                debouncedImageSelected(selectedImage, nonSelectedImage);
            }
            function imageSelected(selectedImagePath, nonSelectedImagePath) {
                console.log("Selected image:", selectedImagePath);
                const selectedImageMatch = selectedImagePath.match(/(\d+)\/(\d+)\.jpg$/);
                const nonSelectedImageMatch = nonSelectedImagePath.match(/(\d+)\/(\d+)\.jpg$/);
                if (selectedImageMatch && nonSelectedImageMatch) {
                    const postData = { imageId: selectedImageMatch[1], selectedSubId: selectedImageMatch[2], nonSelectedSubId: nonSelectedImageMatch[2] };
                    fetch("/", { method: "POST", headers: { "Content-Type": "application/json" }, body: JSON.stringify(postData) })
                        .then((response) => response.json())
                        .then((data) => {
                            if (data.message === "Duplicate request") {
                                // Notify user or log
                                console.log("Duplicate selection detected, fetching new images."); // Optionally, automatically fetch new images
                                fetchNewImages();
                            } else {
                                // Handle normal response
                                showNotification(data.count);
                                fetchNewImages(); // Function to fetch and update images
                            }
                        });
                } else {
                    console.error("Failed to extract image IDs");
                }
            }
            function fetchNewImages() {
                fetch("/new-images")
                    .then((response) => response.json())
                    .then((data) => {
                        updateImages(data.images);
                    });
            }
            function updateImages(newImages) {
                newImages.forEach((imageSrc, index) => {
                    const container = document.querySelector(`.image-container[data-image-index="${index}"]`);
                    const img = container.querySelector("img");
                    img.src = imageSrc;
                    img.setAttribute("data-image-id", imageSrc.match(/(\d+)\/(\d+)\.jpg$/)[1]);
                    img.setAttribute("data-sub-id", imageSrc.match(/(\d+)\/(\d+)\.jpg$/));
                });
                updateImageEventListeners(); // Reattach event listeners to the new images
            }
            function showNotification(count) {
                var notification = document.getElementById("notification");
                notification.textContent = `${count} people also chose this image`;
                notification.style.display = "block";
                setTimeout(() => {
                    notification.style.display = "none";
                }, 1000); // Display notification for 1 second
            }
            document.addEventListener("keydown", function (event) {
                const imageContainers = document.querySelectorAll(".image-container");
                if (imageContainers.length >= 2) {
                    let selectedImagePath = imageContainers[0].querySelector("img").src;
                    let nonSelectedImagePath = imageContainers[1].querySelector("img").src;
                    if (["ArrowRight", "ArrowLeft"].includes(event.key)) {
                        if (event.key === "ArrowRight") {
                            // Swap the selected and non-selected images if the right arrow key is pressed
                            [selectedImagePath, nonSelectedImagePath] = [nonSelectedImagePath, selectedImagePath];
                        }
                        imageSelected(selectedImagePath, nonSelectedImagePath);
                    }
                }
            }); // Add click event listeners to image containers
            const imageContainers = document.querySelectorAll(".image-container");
            imageContainers.forEach((container) => {
                container.addEventListener("click", function () {
                    const selectedImagePath = this.querySelector("img").src;
                    const nonSelectedImagePath = document.querySelector(`.image-container:not([data-image-index="${this.getAttribute("data-image-index")}"])`).querySelector("img").src;
                    imageSelected(selectedImagePath, nonSelectedImagePath);
                });
            });
            const debouncedImageSelected = debounce(imageSelected, 300); // doesn't work for now
        </script>

        <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
    </body>
</html>
